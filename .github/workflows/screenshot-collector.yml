# .github/workflows/screenshot-collector.yml
name: Build & Publish Screenshot Collector Script

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: screenshot-collector-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  NODE_VERSION: "24"

jobs:
  build-and-upload:
    name: Build and Upload Script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.21

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build screenshot collector
        working-directory: packages/screenshot-collector
        run: bun run scripts/build.ts

      - name: Verify build output
        working-directory: packages/screenshot-collector
        run: |
          set -euo pipefail
          if [[ ! -f dist/screenshot-collector.js ]]; then
            echo "Build output not found: dist/screenshot-collector.js" >&2
            exit 1
          fi
          size=$(stat -c%s dist/screenshot-collector.js 2>/dev/null || stat -f%z dist/screenshot-collector.js)
          echo "Built screenshot-collector.js: $size bytes"

      - name: Resolve release tag
        id: resolve
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"

          # Get the app version from package.json
          version="$(node -p "require('./apps/client/package.json').version")"
          if [[ -z "$version" ]]; then
            echo "Unable to determine app version from apps/client/package.json" >&2
            exit 1
          fi

          # Try both v-prefixed and non-prefixed
          for tag in "v$version" "$version"; do
            if gh release view "$tag" --repo "$repo" >/dev/null 2>&1; then
              echo "Found existing release: $tag"
              printf 'tag=%s\n' "$tag" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          # Create a new draft release if none exists
          tag="v$version"
          echo "Creating draft release: $tag"
          gh release create "$tag" \
            --repo "$repo" \
            --draft \
            --title "$tag" \
            --notes "Release $tag"
          printf 'tag=%s\n' "$tag" >> "$GITHUB_OUTPUT"

      - name: Upload to GitHub Releases
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ steps.resolve.outputs.tag }}
          REPO: ${{ github.repository }}
        working-directory: packages/screenshot-collector
        run: |
          set -euo pipefail
          artifact="dist/screenshot-collector.js"
          echo "Uploading $artifact to $REPO@$RELEASE_TAG"
          gh release upload "$RELEASE_TAG" "$artifact" --repo "$REPO" --clobber
          echo "Upload complete!"

          # Output the download URL for verification
          echo "Download URL: https://github.com/$REPO/releases/download/$RELEASE_TAG/screenshot-collector.js"
