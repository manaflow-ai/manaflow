# System tuning for running multiple dev servers concurrently
#
# Apply temporarily:
#   sudo sysctl -p scripts/sysctl-dev-tuning.conf
#
# Apply permanently:
#   sudo cp scripts/sysctl-dev-tuning.conf /etc/sysctl.d/99-dev-tuning.conf
#   sudo sysctl --system
#
# These settings help prevent crashes when:
# - Running multiple webpack/vite/next dev servers
# - Rapidly starting/stopping dev servers
# - Working with large monorepos with many file watchers

# --- Network ---

# Expand ephemeral port range (default: 32768-60999 = ~28k ports)
# More ports available for dev servers and their connections
net.ipv4.ip_local_port_range = 16384 65535

# Allow reuse of TIME_WAIT sockets immediately
# Critical for rapid start/stop of dev servers on the same ports
net.ipv4.tcp_tw_reuse = 1

# Reduce TIME_WAIT timeout (default: 60s)
# Ports become available faster after killing servers
net.ipv4.tcp_fin_timeout = 15

# Increase connection backlog for busy dev servers
net.core.somaxconn = 8192
net.core.netdev_max_backlog = 8192

# --- File System ---

# Increase system-wide file descriptor limit
fs.file-max = 2097152

# Increase inotify limits (for HMR/file watching)
# Default max_user_watches is often 8192, too low for large monorepos
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 1024

# --- Memory ---

# Increase max memory map areas (helps with large node_modules)
vm.max_map_count = 262144

# --- I/O Performance ---

# Reduce dirty page ratio to prevent write bursts
# Lower values = more frequent smaller writes = less I/O congestion
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5

# Write dirty pages more frequently (500ms instead of 3000ms)
# Prevents large write backlogs that cause I/O wait spikes
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100

# Higher swappiness to use swap more aggressively
# This frees RAM for disk cache, improving I/O performance
vm.swappiness = 80

# Reduce vfs_cache_pressure to keep more dentries/inodes in memory
# Improves performance for workloads with many file operations
vm.vfs_cache_pressure = 50
