#!/bin/bash
# VNC xstartup script for cmux E2B sandbox
# Launches XFCE desktop with Chrome browser open

unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS

# Start XFCE desktop in background
startxfce4 &

# Wait for desktop to initialize
sleep 5

# Ensure user owns their home directory (fix permissions if needed)
chown -R user:user /home/user 2>/dev/null || true

# Launch Chrome browser as user (visible in VNC AND controllable via CDP)
# --remote-debugging-port=9222 enables Chrome DevTools Protocol
# --test-type suppresses the "unsupported --no-sandbox" warning
sudo -u user google-chrome \
    --no-sandbox \
    --test-type \
    --disable-gpu \
    --no-first-run \
    --no-default-browser-check \
    --disable-default-apps \
    --start-maximized \
    --new-window \
    --remote-debugging-port=9222 \
    --remote-debugging-address=127.0.0.1 \
    --user-data-dir=/home/user/.chrome-data \
    "https://google.com" &

# Keep the script running
wait
